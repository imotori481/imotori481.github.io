<!DOCTYPE html>
<html lang="JA">
    <head>
        <meta charset="utf-8" />
        <title>いもとりのページ</title>
        <link rel="icon" href="../images/imotori_fx.png" type="image/png" />
        <link href="../styles/style.css" rel="stylesheet">
    </head>
    <body>
        <div class="bg_gen"></div>
        <div class="main">
            <h1>いもとりのページ</h1>
            <a href="../index.html">ホームに戻る</a>
            <h2>一般</h2>
            <p>どうでもいいことを好きなだけ書く場所です。
                <br>まあ、開発の話がほとんどになるでしょうけど...
            </p>
            <h3>目次</h3>
            <!--TEMPLATE
                <li><a href="#yyyymmdd">yyyy/mm/dd </a></li>
            -->
                <li><a href="#202505">2025/05/ OS自作まとめ編 1~5</a></li>
                <li><a href="#20250526">2025/05/26 OS自作5</a></li>
                <li><a href="#20250520">2025/05/20 OS自作4</a></li>
                <li><a href="#20250516">2025/05/16 OS自作3</a></li>
                <li><a href="#20250511">2025/05/11 OS自作2</a></li>
                <li><a href="#20250507">2025/05/07 OS自作1</a></li>
                <li><a href="#20250506">2025/05/06 OS自作をしよう（唐突）</a></li>
                <li><a href="#20250104">2025/01/04 今日も今日とて京都へ</a></li>
                <li><a href="#20241214">2024/12/14 ProjectCの進捗 対戦編</a></li>
            <br>
            <!--本文-->
            <ul>
                <!--TEMPLATE
                <li id="yyyymmdd">yyyy/mm/dd </li>
                <p>
                    <div class="indent_img">
                        <img src="../images/" alt="" width="60%" height="60%">
                    </div>
                </p>
                -->
                <li id="20250530">2025/05/30 OS自作まとめ編 1~5</li>
                <p>第1回から第5回までの重要な点や補足などを、物凄く適当かつ気の向くままにまとめます。
                    <br>※もし間違いに気づいた方は、各SNSのDMにご指摘ください。

                    <p><strong>・UEFI BIOS</strong></p>
                    <p>Unified Extensible Firmware Interface、Basic Input/Output System
                        <br>OSを起動するため、つまりブートローダを読み出す機能。
                        <br>UEFI BIOSとBIOSは別物ですが、今回はUEFIという表現で統一。
                        <br>細かいことを言うと、UEFIはハードウェアを動かす役割のファームウェアの仕様を定めたものであり、プログラムではありません。
                        <br>しかしOS作りの素人がこんなのを気にしていては埒があきません。BIOSみたいなもんだと認識させていただきます。
                        <br>UEFIのプログラムは.efiという形式にして実行されます。適切にコンパイル&リンクしてあげれば生成されます。
                        <br>
                        <br>コマンド例（Clang & LLD）
                        <blockquote>
                            <p>$ clang -target x86_64-pc-win32-coff -mno-red-zone -fno-stack-protector -fshort-wchar -wall -c "ファイル名".c
                                <br>$ lld-link /subsystem:efi_application /entry:"関数名" /out:"ファイル名".efi "ファイル名".o
                            </p>
                        </blockquote>
                    <p>coff形式で.oファイルを作成 → PE形式で実行ファイル（Windowsの.exeもPE形式）作成という流れですね。
                    </p>
                    </p>
                    
                    <p><strong>・EDK2</strong></p>
                    <p>EFI Development Kit II、最近色々と話題のIntel製のUEFIファームウェアとかアプリの開発環境。
                        <br>EDK2のフォルダの中身を見てみると、その中には大量のフォルダが！全部見てたらキリがないです。
                        <br>大事なのはedksetup.shとMdePkgでしょうかね？
                        <br>前者はビルド環境をセットアップするためのスクリプトで、後者はUefi.hとかが入ってるフォルダです。
                        <br>Uefi.hもインクルードの連続で見るのが億劫になります。お前らどんだけヘッダーファイルあるんだ。
                        <br>他にもLibraryフォルダのUefiLib.hも追っていたら時間がいくらあっても足りません。こっちは1Fも無駄にできないんだ。
                        <br>一応、書籍の付録にedk2のファイル説明の一部が載っているのですが、正直ここに載せるほどのことは書いていません。気になるなら本買って見てくれ（ダイマ）
                    </p>

                    <p><strong>・メモリマップ</strong></p>
                    <p>メインメモリのどこが・何に・どれだけ使われているかを確認できる。
                        <br>もし既に使われているアドレスにデータを置こうものなら、当然死は免れられません。
                        <br>ありがたいことに、BIOSにはメモリマップを確認する機能があります。
                        <br>ブートサービスを表すグローバル変数gBSを使い、GetMemoryMapという関数を呼び出すことで確認できます。
                        <br>なお、GetMemoryMapは、OSがUEFIの制御を離れる前（ExitBootServicesの直前）に呼ぶのが一般的です。
                    </p>

                    <p><strong>・カーネル</strong></p>
                    <p>ハードウェアの資源管理、ハードウェアとソフトウェアを仲介するプログラム
                        <br>UEFIの規格通り作る必要があるが、ブートローダーからカーネルを呼び出す形式にすることで、その制約を回避します。
                        <br>
                        <br>コマンド例（Clang++ & LLD）
                        <blockquote>
                            <p>$ clang++ -O2 -Wall -g --target=x86_64-elf -ffreestanding -mno-red-zone -fno-exceptions -fno-rtti -std=c++17 -c main.cpp
                                <br>ld.lld --entry KernelMain -z norelro --image-base 0x100000 --static -o kernel.elf main.o
                            </p>
                        </blockquote>
                        <p>カーネルを読み込む際は、UEFIのOpen関数でkernel.elfを読み込み、GetInfo関数でファイル情報を取得します。
                            <br>GetInfoの4番目の引数が特殊で、EFI_FILE_INFO型の構造体が入るだけのメモリ領域を指定するのですが、ただ指定するだけではいけません。
                            <br>実は、ここにはelfファイルに付けた名前を格納する必要もあり、その名前の文字数分メモリを多めに確保しなければなりません。
                            <br>今回のkernel.elfはsizeof(CHAR16) * 12バイトだけ多く確保しています。
                        </p>
                    </p>

                    <p><strong>・Graphics Output Protocol</strong></p>
                    <p>UEFIが提供するグラフィック描画プロトコル
                        <br>今回はPixelRedGreenBlueReserved8BitPerColorという規格を使用します。
                        <br>光の三原色でおなじみのRGB（+予約領域 or αチャンネル）を8ビットずつ使うフォーマットです。
                        <br>この規格は最も描画が楽で、ピクセル単位で1つずつ色を付けていきます。
                        <br>中には、一度にバッファに情報を格納してから、一気に描画する方法もありますが、実装がとても大変と聞いているためやってません。
                    </p>

                    <p>思い立ってまとめてみましたが、アフィサイト以下の解説になってしまいました。
                        <br>まあ別にいいでしょう。こんなの短期間で理解できる訳ないし。
                        <br>急ぐのはテトリスだけで充分です。
                    </p>

                </p>

                <li id="20250526">2025/05/26 OS自作5</li>
                <p>文字の描画をやっていきます。
                    <br>前回使用したピクセルを描画する関数を利用＆文字データを用意して描画します。
                    <br>どう文字データを実装するのかと思ったら、まさかの配列に8ビットデータを突っ込む形でした。
                    <br>書籍では"A"だけ描画するサンプルがあります。
                    <div class="indent_img">
                        <img src="../images/g_20250526.png" alt="" width="60%" height="60%">
                    </div>
                    <p>さすがにこれを全部作るのは過酷なので、<a href="http://openlab.ring.gr.jp/efont/shinonome/">東雲フォント</a>を使用することになっていました。
                    <br>こちらを読み込ませると、無事に文字が使えるようになります。
                    <br>文字列を引数で渡して描画する関数も用意します。
                    <br>他にもprintfのような書式整形付きの関数も欲しいですが、標準ライブラリのNewlibから、sprintfで代用することに。
                    <br>NewlibはOSの依存度が低いらしいですが、その代わりに動的メモリ管理や入出力周りの一部は自分で実装しなければなりません。セルフサービスです。
                    <br>Newlibのヘッダーファイルをインクルードして、sprintfを使うと、書式整形付きの文字列が描画できるようになります。
                    <div class="indent_img">
                        <img src="../images/g_20250526-2.png" alt="" width="60%" height="60%">
                    </div>
                    <p>まだまだやります。
                        <br>Linuxではカーネルコンソールに出力する関数であるprintkを模した関数を作ります。
                        <br>こちらも可変長の引数を受け取る関数で、printfと同じように書式整形ができるようになっています。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_20250526-3.png" alt="" width="60%" height="60%">
                    </div>
                    <p> これがあれば、ログ出力も容易になり開発が楽になることでしょう。
                        <br>次回はマウス入力を...と言いたい所ですが、次は1～5回のまとめに入ろうと思います。
                        <br>急にどうしたのかといいますと、更新頻度を保とうとすると内容が薄くなってしまうのが気がかりだったのです。
                        <br>そのため、5回に1回はこれまでの内容をもっと深く掘り下げて、内容を充実させる方を優先させて頂きます。
                        <br>というわけで、次回は1～5回までのまとめを行います。
                    </p>
                </p>

                <li id="20250520">2025/05/20 OS自作4</li>
                <p>makeだったり描画だったりをやっていきます。
                    <br>書籍にあるmakeのサンプルを実行しようとしたのですが、インクルード出来ねえよハゲと一蹴されてしまいました。
                    <br>これも前回と同じく<a href="https://github.com/uchan-nos/os-from-zero/issues/82">Issue</a>が立っていたので、そちらを参考にして実行できるようにしました。
                    <p>Makefileは完全に初見ですが、これを機に書き方だけちょっと見てきました（本当に見ただけ）
                        <br>コンパイル時のコマンドをまとめてくれるのは間違いなく便利なので、ここや別の環境でも慣れておきたい所です。
                    </p>
                    <p>さて、Makefileの話はここまでにして、描画をやってみましょう。
                        <br>前回まではフレームバッファに直接値を書き込んでいましたが、人間にはあまりにも使いづらいので手を加えます。
                        <br>UEFIにはピクセルデータを扱う規格が4つもあるのですが、書籍ではその内の扱いやすい2つを利用します。
                        <br>1つはRGBと座標を指定してピクセルを描画し、もう一つはBGRを指定します（順番変わっただけでは...?）
                        <br>歴史的な理由でBGRもあるらしいですが、個人的にRGBの方が分かりやすいのでそちらを使います。
                    </p>
                    <p>早速main.cppに描画用クラスを用意し、そこに座標や色を指定して描画できるメンバ関数を実装します。
                        <br>書籍に緑色の長方形を描くサンプルがあったので、これを実行してみます。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_20250520.png" alt="" width="60%" height="60%">
                    </div>
                    <p>無事に描画されましたね。
                    </p>
                    <p>せっかくなので、私も何か描いてみましょう。
                        <br>私がよく使っている山岳積み二号です。
                        <br>どう考えてもこんなのやってる暇ねえだろというツッコミは受け付けておりません。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_20250520-2.png" alt="" width="60%" height="60%">
                    </div>
                    <p>次回は文字の描画を行います。</p>
                </p>
                <br>
                <li id="20250516">2025/05/16 OS自作3</li>
                <p>ブートローダやカーネルを作成していきます。
                    <br>まずはmain.cppに特に何も起こらないだけのカーネルを書きます。
                    <br>名前修飾やインラインアセンブラといった初見の要素ばかりですが、この書き方にも少しずつ慣れていかねば。
                    <br>コンパイルとリンクが終わるとkernel.elfファイルが生成されます。
                    <p>ブートローダでもカーネルを読み込めるように、Main.cも修正します。
                        <br>カーネルを配置する番地を指定したり、ファイルを読み込めるようにメモリを確保したりします。
                        <br>ビルドしてQEMUで起動して、無事に動けば成功です。
                    </p>
                    <p>このときは気づいていなかったのですが、私がここで作ったカーネルは正常に動作していませんでした。
                        <br>どうやら書籍では、リンカはLLVM-7の使用を前提としており、LLD10では動作しないようです。
                        <br>LLVM-7は古いため、Ubuntu20.04にすらデフォルトで入っておらず、わざわざダウングレー
                        <br>ドしなければなりません。
                    </p>
                    <p>この件については公式のGitHubに<a href="https://github.com/uchan-nos/os-from-zero/issues/168">Issue</a>が立っていたため、そちらを参考にしました。
                        <br>バージョン違いでのエラーは別界隈で慣れていましたが、自作OSでも同じ目に遭うとは...油断しました。
                    </p>
                    <p>この事実に気づかず私が次にやっていたのは、ブートローダ上で画面を白く塗り潰す命令でした。
                        <br>こちらは特に問題なく動作します、カーネルを使ってる訳ではないので。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_20250516.png" alt="" width="60%" height="60%">
                    </div>
                    <p>次はカーネルを使って、画面をグラデーションのように塗りつぶす命令を作ります。
                        <br>しかし、なぜか命令を書いても画面が白いままです。
                        <br>それもそのはず、あなた、リンカのバージョンを間違えてますよ？
                        <br>これに気づかず何時間も四苦八苦していました。もう少し早くIssueを見ていれば...。
                        <br>
                        <br>四苦八苦と言ったら一つネタを思いつきました。
                        <p><strong>テトリスは、四楽八苦</strong>（これが通じる人は、もう立派なTGMプレイヤーです）</p>
                    <p>そんな冗談はさておき、リンカのバージョンを直してからカーネルをビルドし直すと、ちゃんとグラデーションが表示されました。</p>
                    <div class="indent_img">
                        <img src="../images/g_20250516-2.png" alt="" width="60%" height="60%">
                    </div>
                    <p>最後に、簡易的なエラー処理を実装しましょう。
                        <br>といっても単純なもので、ブートローダ上でエラーメッセージの表示をするだけです。
                        <br>あと無限ループを呼び出して無理やり実行を止める感じですかね。
                    </p>
                    <p>次回は画面に絵を描く命令を実装していきます。
                    </p>
                </p>
                <br>
                <li id="20250511">2025/05/11 OS自作2</li>
                <p>EDK IIやメモリについての話です。最初だから仕方ないけど地味な要素が多い...。
                    <p>どうやらEDK2（II表記は面倒なので2でいいよね）はUEFI BIOSや、そのUEFI BIOS上で動くアプリの開発ができるとのこと。
                        <br>開発環境は書籍の付録に付いているGitHubのリンクがあるので、そこからダウンロー
                        <br>ドすることができます。
                    </p>
                    <p>では、EDK2を用いてHello, World!をやってみます。実行結果だけ見たらほぼ再放送です。
                        <br>Main.cには、EDK2フォルダ内にあるヘッダーファイルをincludeしてからプログラムを書きます。
                        <br>普段のC言語との違いは、最初に実行されるのはmain関数ではなく、Loader.infファイルにENTRY_POINTという項目があり、そこで設定した名前がmain関数の代わりになる所でしょうか？
                        <br>あとprintfは使わず、Uefi.hで定義されているPrint関数を使うみたいです。一応printfとほぼ同じ挙動をするのでそこまで違和感はないです。
                    </p>
                    <p>他にも機能を実装しましょう。今回はメモリマップをcsvファイルに書き込む機能を作ります。
                        <br>書籍にはコードの解説も載っているのですが、それ以上にポインタの解説が多いです。
                        <br>やはりポインタは難しいので、著者も念入りに教えておきたいのでしょう...（まずポインタ分からん人は他の内容も大丈夫なのか？という疑問も残りますが）
                    </p>
                    <p>完成したらビルドして起動します。
                        <br>ちゃんと起動するまで結構ミスりました...根気がないとやってられん作業ですねえ。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_202505010.png" alt="" width="60%" height="60%">
                    </div>
                    <p>出力されたcsvファイルも確認してみましょう。
                        <br>アドレスが表示されまくってます。1つくらい勝手に使ってもバレへんかな。
                    </p>
                    <div class="indent_img">
                        <img src="../images/g_202505010-2.png" alt="" width="60%" height="60%">
                    </div>
                    <p>次回はブートローダを作成し、いよいよOS本体にも手を出していきます。
                    </p>
                </p>
                <br>
                <li id="20250507">2025/05/07 OS自作1</li>
                <p>環境構築からHello, World!までを試してみました。
                    <br>まず開発環境について、最初はWSL2とUbuntu24.04を使おうと思ったのですが、<a href="https://github.com/uchan-nos/mikanos-build">これ</a>
                        を見る限り非推奨らしいのでUbuntu20.04を別で用意しました。
                    <br>Ubuntu上にディスクイメージを用意してQEMUで起動する、という流れでHello, World!まで進めます。
                    <br>C言語でやるのかなと思いきや、最初だけなぜかバイナリエディタで書かされました、飛鳥時代でもこんなんやらんぞ。
                    <br>
                    <br>作ったバイナリファイルをさっき作ったディスクイメージに読み込ませてから起動すると...
                    <div class="indent_img">
                        <img src="../images/g_02050507.png" alt="" width="60%" height="60%">
                    </div>
                    <p>なんとHello, World!が表示されたではありませんか！どうなってんだこれ（無知）
                        <br>仕組みは追々調べるとして、とりあえず起動は成功です。
                        <br>次回はUEFI用の開発キット EDK IIを試します。
                    </p>
                </p>
                <br>
                <li id="20250506">2025/05/06 OS自作をしよう（唐突）</li>
                <p>大学でソフトウェア系の授業を担当している教授が、技術を身につけるための活動をしていると聞いて参加してみました。
                    <br>参加者は7,8人ほど（しかも全員知り合い）で、自由に何でもやっていい感じの雰囲気でした。
                    <br>せっかくの機会なので、私は無謀にもOSの自作に挑戦することにしました。
                    <br>何があっても逃げられないように速攻で内田公太氏の「ゼロからのOS自作入門」を購入。
                    <br>ここに色々書いているのも逃げ場を塞ぐ一環でございます。
                </p>
                <p>正直なところ、私一人の力だけで完成させられる気がしません。
                    <br>去年までポインタで苦しんでいたような人間に出来るのでしょうか...?
                </p>
                <p>しかし今回はありがたいことに、心強い味方が大勢います！
                    <br>電子系・情報系の学生と教授がサポートしてくれるのです。こんないい環境が他にあるというのか。
                    <br>というか、これだけ協力者がいるのに諦めるのは無理です。裏切るわけにいかん...。
                </p>
                <p>目標としては、2か月以内での完成を目指しています。
                    <br>今回使う書籍では1か月が目標とされていますが、他のメンバーとの折り合い&これとは別の活動で多忙なため、ある程度余裕は持たせておきます。
                    <br>果たしてOSは完成するのか？ すべては明日の私にかかっている！
                </p>
                <br>
                <li id="20250104">2025/01/04 今日も今日とて京都へ</li>
                <p>本日は高校の友人たちと北野天満宮まで行って参りました。
                    <br>流石に4日なので人はそこまで多くなかったです。
                    <div class="indent_img">
                        <img src="../images/g-20250104-2.JPG" alt="北野天満宮" width="60%" height="60%">
                    </div>
                    <br>テトリスが上手くなるのを願って、賽銭は20円にしました。
                    <br>延命長寿のお守りも買っておきました。Moddedマイクラやテトリスは時間がいくらあっても足りないので...。
                </p>
                <p>近くにうまいラーメン屋もありました。
                    <div class="indent_img">
                        <img src="../images/g_20250104.jpg" alt="みそラーメン" width="60%" height="60%">
                    </div>
                    <br>偏食なので、ラーメン食う時は毎回みそを注文してます。
                </p>
                <p>京都に来たついでにa-choでTGMをしましたが、Shirase S8という残念な結果に...。
                    <br>次来たときはS12まで行きたいですね。
                </p>
                <br>
                <li id="20241214">2024/12/14 ProjectCの進捗 対戦編</li>
                <p>11月から開発を進めているProjectCですが、3割くらい完成したので報告だけしておきます。
                    <br>某対戦アクションパズルゲームのような何かですね。
                    <div class="indent_img">
                        <img src="../images/g_20241214.png" alt="対戦容認中" width="60%" height="60%">
                    </div>
                    <br>今のところローカル環境でのみ対戦可能。
                    <br>操作はTGM、対戦はテトエフェ寄りの仕様を目指しています。
                    <br>RENテーブルはテトリスの歴史を見て、独自のものを使用することにしました。
                    <blockquote>
                    2~5REN   +1
                    <br>6~10REN  +2 
                    <br>11~16REN +3
                    <br>17~REN   +4
                    </blockquote>
                    今後もテストプレイを重ねてバランス調整しようと思います。
                </p>    
            </ul>
            <a href="../index.html">ホームに戻る</a>
        </div>
    </body>
</html>